<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Find Your Bookings - Cafe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #e3f2fd;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0b7dda;
        }
        button#backToHome {
            background-color: #4CAF50;
        }
        button#backToHome:hover {
            background-color: #45a049;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        #results {
            margin-top: 20px;
        }
        .booking-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .booking-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .btn-edit {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
        }
        .btn-edit:hover {
            background-color: #0b7dda;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
        }
    </style>
</head>
<body>
<h1>üîç Find Your Bookings</h1>

<!-- Error message -->
<div id="errorMessage" class="error"></div>

<!-- Success message -->
<div id="successMessage" class="success"></div>

<form id="searchForm">
    <div class="form-group">
        <label for="searchEmail">Search by Email:</label>
        <input type="email" id="searchEmail" placeholder="your.email@example.com"/>
    </div>

    <div class="form-group">
        <label for="searchPhone">Or Search by Phone:</label>
        <input type="tel" id="searchPhone" placeholder="555-1234"/>
    </div>

    <button type="submit">Search</button>
    <button type="button" id="backToHome">Back to Home</button>
</form>

<div id="results"></div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Booking</h2>
        <form id="editBookingForm">
            <input type="hidden" id="editBookingId">

            <div class="form-group">
                <label for="editCustomerName">Name:</label>
                <input type="text" id="editCustomerName" required/>
            </div>

            <div class="form-group">
                <label for="editEmail">Email:</label>
                <input type="email" id="editEmail" required/>
            </div>

            <div class="form-group">
                <label for="editPhone">Phone:</label>
                <input type="tel" id="editPhone" required/>
            </div>

            <div class="form-group">
                <label for="editReservationDate">Reservation Date:</label>
                <input type="date" id="editReservationDate" required/>
            </div>

            <div class="form-group">
                <label for="editReservationTime">Reservation Time:</label>
                <select id="editReservationTime" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select a time --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="editNumberOfGuests">Number of Guests:</label>
                <input type="number" id="editNumberOfGuests" min="1" max="20" required/>
            </div>

            <button type="submit">Update Booking</button>
        </form>
    </div>
</div>

<script>
    // Back to Home button - MUST be at the top
    document.getElementById('backToHome').addEventListener('click', function() {
        window.location.href = '/booking_form.html';
    });

    // Helper functions
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = '‚ùå ' + message;
        errorDiv.style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = '‚úÖ ' + message;
        successDiv.style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 5000);
    }

    // Search form submission
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide previous messages
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';

        const email = document.getElementById('searchEmail').value.trim();
        const phone = document.getElementById('searchPhone').value.trim();

        if (!email && !phone) {
            showError('Please enter either an email or phone number');
            return;
        }

        try {
            let response;
            if (email) {
                response = await fetch(`/api/bookings/email/${encodeURIComponent(email)}`);
            } else {
                response = await fetch(`/api/bookings/phone/${encodeURIComponent(phone)}`);
            }

            if (response.ok) {
                const bookings = await response.json();
                displayBookings(bookings);
            } else if (response.status === 404) {
                showError('No bookings found');
                document.getElementById('results').innerHTML = '';
            } else {
                showError('Error searching for bookings');
            }
        } catch (error) {
            showError('Network error. Please try again.');
            console.error('Error:', error);
        }
    });

    // Display bookings
    function displayBookings(bookings) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        bookings.forEach(booking => {
            const bookingCard = document.createElement('div');
            bookingCard.className = 'booking-card';
            bookingCard.innerHTML = `
                    <h3>${booking.customerName}</h3>
                    <p><strong>Email:</strong> ${booking.email}</p>
                    <p><strong>Phone:</strong> ${booking.phone}</p>
                    <p><strong>Date:</strong> ${booking.reservationDate}</p>
                    <p><strong>Time:</strong> ${booking.reservationTime}</p>
                    <p><strong>Guests:</strong> ${booking.numberOfGuests}</p>
                    <div class="booking-actions">
                        <button class="btn-edit" onclick="openEditModal(${booking.id})">Edit Booking</button>
                    </div>
                `;
            resultsDiv.appendChild(bookingCard);
        });
    }

    // Open edit modal
    async function openEditModal(bookingId) {
        try {
            const response = await fetch(`/api/bookings/${bookingId}`);
            if (!response.ok) {
                showError('Unable to load booking details');
                return;
            }

            const booking = await response.json();

            // Populate form
            document.getElementById('editBookingId').value = booking.id;
            document.getElementById('editCustomerName').value = booking.customerName;
            document.getElementById('editEmail').value = booking.email;
            document.getElementById('editPhone').value = booking.phone;
            document.getElementById('editReservationDate').value = booking.reservationDate;
            document.getElementById('editNumberOfGuests').value = booking.numberOfGuests;

            // Load available time slots
            await loadAvailableTimesForEdit(booking.reservationDate, booking.reservationTime);

            // Show modal
            document.getElementById('editModal').style.display = 'block';
        } catch (error) {
            showError('Error loading booking: ' + error.message);
        }
    }

    // Load available times for edit modal
    async function loadAvailableTimesForEdit(date, currentTime) {
        try {
            const response = await fetch(`/api/bookings/available-times/${date}`);
            const timeslots = await response.json();

            const selectElement = document.getElementById('editReservationTime');
            selectElement.innerHTML = '<option value="">-- Select a time --</option>';

            // Add current time even if not in available list
            if (currentTime && !timeslots.includes(currentTime)) {
                timeslots.push(currentTime);
                timeslots.sort();
            }

            timeslots.forEach(timeslot => {
                const option = document.createElement('option');
                option.value = timeslot;
                option.textContent = timeslot;
                if (timeslot === currentTime) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading time slots:', error);
        }
    }

    // Handle date change in edit form
    document.getElementById('editReservationDate').addEventListener('change', async function() {
        const selectedDate = this.value;
        const currentTime = document.getElementById('editReservationTime').value;
        await loadAvailableTimesForEdit(selectedDate, currentTime);
    });

    // Close modal handlers
    document.querySelector('.close').onclick = function() {
        document.getElementById('editModal').style.display = 'none';
    };

    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };

    // Handle edit form submission
    document.getElementById('editBookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const bookingId = document.getElementById('editBookingId').value;
        const updatedBooking = {
            customerName: document.getElementById('editCustomerName').value,
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value,
            reservationDate: document.getElementById('editReservationDate').value,
            reservationTime: document.getElementById('editReservationTime').value,
            numberOfGuests: parseInt(document.getElementById('editNumberOfGuests').value)
        };

        try {
            const response = await fetch(`/api/bookings/${bookingId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedBooking)
            });

            if (response.ok) {
                showSuccess('Booking updated successfully!');
                document.getElementById('editModal').style.display = 'none';
                // Refresh the bookings list
                document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            } else {
                const errorData = await response.json();
                showError(errorData.error || 'Unable to update booking');
            }
        } catch (error) {
            showError('Network error. Please try again.');
        }
    });
</script>
</body>
</html>